# S04 - Шаблон STRIDE per element (матрица)

## Матрица угроз STRIDE

| Element                                    | Data/Boundary                  | Threat (S/T/R/I/D/E) | Description                                                                                | NFR link (ID)    | Mitigation idea (ADR later)                                                                    |
| :----------------------------------------- | :----------------------------- | :------------------- | :----------------------------------------------------------------------------------------- | :--------------- | :--------------------------------------------------------------------------------------------- |
| **USER_AGENT**                             | Клиент/Браузер                 | S                    | Подмена легитимного пользователя через кражу учетных данных                                | NFR-009          | MFA + короткоживущие JWT токены                                                                |
| **USER_AGENT**                             | Клиент/Браузер                 | R                    | Отрицание операций из-за недостаточного аудита действий на клиенте                         | NFR-008          | Централизованный аудит всех действий на бэкенде с WORM-хранилищем                              |
| **Edge: USER_AGENT -> Wishlist_GW**        | JWT/HTTPS, correlation_id      | S                    | Подделка/перехват JWT токенов (Replay Attack)                                              | NFR-009          | JWT с коротким TTL + refresh tokens, использование `jti`                                       |
| **Edge: USER_AGENT -> Wishlist_GW**        | JWT/HTTPS, correlation_id      | T                    | Изменение параметров запроса для обхода лимитов пагинации                                  | NFR-003          | Строгая валидация `limit`/`offset` по спецификации на сервере                                  |
| **Edge: USER_AGENT -> Wishlist_GW**        | JWT/HTTPS, correlation_id      | D                    | DDoS-атака на публичные API-эндпойнты                                                      | NFR-001, NFR-002 | Rate limiting + WAF на уровне API Gateway                                                      |
| **Edge: USER_AGENT -> Wishlist_GW**        | JWT/HTTPS, correlation_id      | R                    | Невозможность отследить полный путь вредоносного запроса из-за отсутствия `correlation_id` | NFR-004          | Принудительная проверка наличия `X-Correlation-ID`. Генерация ID на Gateway, если отсутствует. |
| **Wishlist_GW**                            | API Gateway                    | D                    | Перегрузка сервиса большим количеством одновременных запросов                              | NFR-001, NFR-002 | Автоскейлинг + pattern Circuit Breaker                                                         |
| **Wishlist_GW**                            | API Gateway                    | I                    | Утечка внутренней структуры системы через детализированные ошибки                          | NFR-003          | Возврат ошибок по стандарту RFC 7807 без stack traces                                          |
| **Edge: Wishlist_GW -> Wishlist_Service**  | DTO, correlation_id, tenant_id | I                    | Перехват конфиденциальных данных во внутреннем трафике                                     | NFR-005, NFR-007 | mTLS (взаимная аутентификация) между сервисами                                                 |
| **Wishlist_Service**                       | Бизнес-логика                  | E                    | Обход RBAC через уязвимости в логике (например, IDOR)                                      | NFR-005, NFR-006 | Проверка прав на каждом уровне + unit-тесты на кейсы AuthZ                                     |
| **Wishlist_Service**                       | Бизнес-логика                  | T                    | Изменение логики для обхода tenant isolation                                               | NFR-005, NFR-010 | Strict RBAC policies + обязательная фильтрация по `tenant_id`                                  |
| **Edge: Wishlist_Service -> PostgreSQL**   | SQL/ORM, tenant_id             | T                    | SQL-инъекции через непараметризованные или некорректно составленные запросы                | NFR-010          | Использование Prepared Statements и параметризации в ORM                                       |
| **Edge: Wishlist_Service -> PostgreSQL**   | SQL/ORM, tenant_id             | I                    | Нарушение изоляции тенантов на уровне запроса к БД                                         | NFR-005, NFR-010 | Внедрение Row-Level Security (RLS) + автоматическое добавление `tenant_id` в запросы           |
| **PostgreSQL**                             | База данных                    | I                    | Прямой доступ к БД и утечка данных всех тенантов                                           | NFR-005, NFR-007 | Шифрование БД (TDE), шифрование бэкапов, строгие сетевые политики и контроль доступа           |
| **PostgreSQL**                             | База данных                    | D                    | Отказ службы из-за ресурсоемких SQL-запросов                                               | NFR-010          | Ограничение времени выполнения запроса (query timeouts) + connection pooling                   |
| **Edge: Wishlist_Service -> Logs_Service** | Masked PII logs, audit_events  | I                    | Перехват логов с остаточной конфиденциальной информацией во внутреннем трафике             | NFR-007          | mTLS между сервисами, дополнительная фильтрация логов                                          |
| **Edge: Wishlist_Service -> Logs_Service** | Masked PII logs, audit_events  | R                    | Потеря критически важных событий аудита при сбое сервиса логов                             | NFR-008          | Асинхронная отправка через очередь с guaranteed delivery                                       |
| **Logs_Service**                           | Административный сервис        | I                    | Неавторизованный доступ к логам с конфиденциальной информацией                             | NFR-007, NFR-008 | Ролевая модель доступа (RBAC) к логам, шифрование данных в хранилище                           |
| **Logs_Service**                           | Административный сервис        | T                    | Модификация или удаление аудит-логов авторизованным пользователем                          | NFR-008          | Использование неизменяемого (immutable) WORM-хранилища                                         |
| **Edge: Logs_Service -> Logs_PostgreSQL**  | SQL/ORM                        | T                    | Изменение исторических логов в базе данных напрямую                                        | NFR-008          | Настройка прав доступа к БД в режиме append-only (только на добавление)                        |
| **Edge: Logs_Service -> Logs_PostgreSQL**  | SQL/ORM                        | I                    | Утечка аудит-логов с PII из хранилища в случае компрометации                               | NFR-007          | Шифрование на уровне столбцов (Column-level encryption) для полей с PII                        |
| **Logs_PostgreSQL**                        | База данных логов              | I                    | Неавторизованный прямой доступ к полным аудит-логам                                        | NFR-007, NFR-008 | Шифрование БД (TDE), строгие сетевые политики и контроль доступа к БД                          |

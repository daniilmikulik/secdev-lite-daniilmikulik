# ADR: Rate Limiting and Autoscaling Strategy

**Status**: `Proposed`

## Context

**Risk**: `R-02` "Отказ в обслуживании (DoS) из-за DDoS-атак или исчерпания ресурсов" (L=4, I=4, **Score=16**) (Top-2). Публичные API являются основной целью для атак на доступность, которые могут привести к полному простою сервиса и финансовым потерям.
**DFD**: Входящий поток `Edge: USER_AGENT -> Wishlist_GW` и узел `Wishlist_GW` (API Gateway).
**NFR**: `NFR-001 (Performance)`, `NFR-002 (Scalability)`.
**Assumptions**:

- Сервис развернут в контейнеризированной среде (например, Kubernetes), которая поддерживает горизонтальное автомасштабирование (HPA).
- Перед сервисом стоит API Gateway (например, Nginx, Kong, или облачный), способный применять политики ограничения скорости.

## Decision

Мы внедряем **комплексную стратегию повышения отказоустойчивости**, включающую меры на стороне сервера и рекомендации для клиентов.

1.  **Первый уровень (На входе):** Настройка **Rate Limiting** на API Gateway для отсечения аномального трафика.
2.  **Второй уровень (Внутри):** Настройка **Autoscaling** для `Wishlist_Service` для эластичного масштабирования под легитимной нагрузкой.
3.  **Третий уровень (Клиент):** Внедрение **стратегии повторных запросов с экспоненциальной задержкой (Exponential Backoff)** для клиентов, чтобы они не перегружали сервис повторными попытками.

- **Политика 1: Кооперативный Rate Limiting на API Gateway.**

  - **Описание**: Применяем алгоритм Token Bucket для ограничения скорости запросов. При превышении лимита сервер **обязан** вернуть заголовок `Retry-After`, указывающий клиенту, через сколько секунд можно повторить попытку.
  - **Лимит по IP**: `100 запросов в минуту`.
  - **Лимит по User ID (из JWT)**: `250 запросов в минуту`.
  - **Слой**: `API Gateway`.

- **Политика 2: Horizontal Pod Autoscaling (HPA) для сервисов.**

  - **Описание**: Конфигурируем автомасштабирование для `Wishlist_Service`.
  - **Триггер**: `CPU Utilization > 70%` в течение 2 минут.
  - **Масштаб**: `minReplicas = 2`, `maxReplicas = 10`.
  - **Слой**: `Service`.

- **Политика 3: Клиентская стратегия Exponential Backoff.**
  - **Описание**: Все разрабатываемые нами клиенты (веб-фронтенд, мобильные SDK) должны реализовывать механизм повторных запросов с экспоненциально растущей задержкой (+jitter) при получении ответов `429` или `5xx`. Клиенты должны в первую очередь ориентироваться на значение заголовка `Retry-After`.
  - **Слой**: `Клиент/Браузер`.

## Alternatives

- **Только Autoscaling** - **Отклонено.** Причина: В случае DDoS-атаки сервис будет масштабироваться до предела, что приведет к огромным затратам и в итоге все равно к отказу.
- **Только Rate Limiting без клиентской кооперации** - **Отклонено.** Причина: Наивные клиенты, получив `429`, будут немедленно повторять запросы, создавая "retry-шторм" и не давая системе восстановиться.
- **Использование внешнего Anti-DDoS провайдера (e.g., Cloudflare)** - **Рассмотреть в будущем.** Причина: Это более дорогое и комплексное решение. На текущем этапе достаточно встроенных механизмов, но это следующий логический шаг.

## Consequences

- **Положительные:**
  - Существенно повышается устойчивость к DDoS-атакам и легитимным всплескам трафика (`NFR-001`, `NFR-002`).
  - **Предотвращение каскадных сбоев**, вызванных "retry-штормами".
  - Улучшение клиентского опыта: запросы в итоге выполняются успешно, а не упираются в стену лимитов.
- **Негативные/издержки:**
  - Усложнение клиентской логики; требуется разработка или использование готовых библиотек для Exponential Backoff.
  - Необходимость поддерживать и документировать как серверную, так и клиентскую часть стратегии.

## DoD / Acceptance

**Часть 1: Rate Limiting & Retry-After**

- **Given** клиент с IP `1.2.3.4`.
- **When** он отправляет 101-й запрос к `/api/items` в течение одной минуты.
- **Then** он получает ответ с кодом `429 Too Many Requests` **и** заголовком `Retry-After`, содержащим целочисленное значение секунд.

**Часть 2: Autoscaling**

- **Given** сервис работает с `2` репликами при CPU < 70%.
- **When** нагрузочный тест повышает среднюю загрузку CPU до 75% в течение 2 минут.
- **Then** в кластере запускается 3-я реплика `Wishlist_Service`, а P95 latency не превышает 300ms.

**Checks:**

- `test`:
  1.  Нагрузочный тест, проверяющий, что после превышения лимита возвращается `429` с заголовком `Retry-After`.
  2.  Нагрузочный тест, проверяющий корректную работу HPA.
  3.  Unit/интеграционные тесты для наших клиентов, демонстрирующие логику Exponential Backoff.
- `log`: Логи API Gateway фиксируют события блокировки по Rate Limit с кодом `429`.
- `scan/policy`:
  1.  Конфигурация API Gateway и HPA в GitOps-репозитории соответствует заданным параметрам.
  2.  Публичная API-документация обновлена и содержит раздел о Rate Limiting и рекомендации по использованию `Retry-After` / Exponential Backoff.
- `metric`: Метрики Prometheus/Grafana показывают: а) количество ответов `429`; б) количество реплик сервиса в зависимости от нагрузки.

## Rollback / Fallback

- **Rate Limiting**: Правила на API Gateway можно временно отключить или смягчить. Отключение отправки `Retry-After` также является возможным шагом отката.
- **Autoscaling**: HPA можно отключить, установив `minReplicas` и `maxReplicas` в одинаковое фиксированное значение.

## Trace

- **DFD**: `Edge: USER_AGENT -> Wishlist_GW`, `Wishlist_GW`.
- **STRIDE**: Риск `D` для потока `USER_AGENT -> Wishlist_GW` и узла `Wishlist_GW`.
- **Risk scoring**: `R-02` (Top-2)
- **NFR**: `NFR-001`, `NFR-002`
- **Issues**: `#SEC-003` (Configure Rate Limiting & Retry-After on GW), `#SEC-004` (Configure HPA for Wishlist Service), `#SEC-005` (Implement Exponential Backoff in Web Client).

## Ownership & Dates

**Owner**: DevOps Team Lead
**Reviewers**: Backend Team Lead, Security Team Lead, Frontend Team Lead
**Date created**: 2025-10-12
**Last updated**: 2025-10-12

# Матрица сравнения альтернатив R001: "PII Masking and Anonymization in Logs"

## 1) Контекст риска

- **Risk-ID:** `R-01` **Threat:** `I` (Information Disclosure)
- **DFD element/edge:** `Edge: Wishlist_Service -> Logs_Service`
- **NFR link (ID):** `NFR-007 (Privacy/PII)`, `NFR-008 (Auditability)`
- **L×I (1-5):** `L=4, I=4, Score=16`
- **Ограничения/предпосылки:** Используется структурированное логирование (JSON), централизованная библиотека логирования.

---

## 2) Таблица сравнения вариантов

| Alternative     | Summary (1-2 фразы)                         | Security impact (↑,1-5) | Blast radius reduction (↑,1-5) | Complexity (↓,1-5) | Time-to-mitigate (↓,1-5) | Dependencies (↓,1-5) | **Benefit** | **Cost** | **Net** | Notes                                                                          |
| :-------------- | :------------------------------------------ | ----------------------: | -----------------------------: | -----------------: | -----------------------: | -------------------: | ----------: | -------: | ------: | :----------------------------------------------------------------------------- |
| **A (Выбрана)** | **Авто-маскирование в коде сервиса**        |                       5 |                              5 |                  2 |                        2 |                    1 |      **10** |    **5** |  **+5** | PII не покидают контур сервиса. Высокая надежность и точность.                 |
| **B**           | Маскирование в коллекторе логов (Logstash)  |                       3 |                              3 |                  3 |                        2 |                    2 |       **6** |    **7** |  **-1** | PII передаются по сети в открытом виде. Меньше контекста для маскирования.     |
| **C**           | Ручное маскирование разработчиками          |                       2 |                              2 |                  1 |                        5 |                    1 |       **4** |    **7** |  **-3** | Ненадежно, зависит от человеческого фактора. Высокие затраты времени на ревью. |
| **D**           | Полный запрет на логирование объектов с PII |                       4 |                              5 |                  2 |                        2 |                    1 |       **9** |    **5** |  **+4** | Снижает наблюдаемость, сильно усложняет отладку и расследование инцидентов.    |

---

## 4) Решение (для переноса в ADR)

- **Chosen alternative:** `A` - **Авто-маскирование в коде сервиса**
- **Почему:** Этот вариант обеспечивает максимальное снижение риска (`Security Impact = 5`), так как PII не покидают доверенный контур сервиса в незащищенном виде. При этом сложность внедрения (`Сomplexity = 2`) и зависимость (`Dependencies = 1`) минимальны, так как решение реализуется в рамках существующей библиотеки логирования. Альтернатива D (полный запрет) также эффективна, но имеет критический недостаток - сильно ухудшает наблюдаемость системы, что неприемлемо.
- **ADR candidate (название):** `PII Masking and Anonymization in Logs`
- **Связки:** Risk-ID `R-01`, NFR-ID `NFR-007`, `NFR-008`, DFD `Edge: WS -> Logs_Service`.
- **Следующие шаги:**
  1. Разработать middleware/декоратор для библиотеки логирования.
  2. Внедрить аннотации `@PiiField`.
  3. Провести аудит и аннотировать существующие DTO/модели.
  4. Обновить документацию для разработчиков.
  5. Настроить SAST-сканер на поиск не-маскированных PII.

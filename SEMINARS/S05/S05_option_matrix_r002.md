# Матрица сравнения альтернатив: R002 "Rate Limiting and Autoscaling Strategy"

## 1) Контекст риска (из S04)

- **Risk-ID:** `R-02` **Threat:** `D` (Denial of Service)
- **DFD element/edge:** `Edge: USER_AGENT -> Wishlist_GW`
- **NFR link (ID):** `NFR-001 (Performance)`, `NFR-002 (Scalability)`
- **L×I (1-5):** `L=4, I=4, Score=16`
- **Ограничения/предпосылки:** Сервис в Kubernetes, используется API Gateway.

---

## 2) Таблица сравнения вариантов

| Alternative     | Summary (1-2 фразы)                           | Security impact (↑,1-5) | Blast radius reduction (↑,1-5) | Complexity (↓,1-5) | Time-to-mitigate (↓,1-5) | Dependencies (↓,1-5) | **Benefit** | **Cost** | **Net** | Notes                                                                                                    |
| :-------------- | :-------------------------------------------- | ----------------------: | -----------------------------: | -----------------: | -----------------------: | -------------------: | ----------: | -------: | ------: | :------------------------------------------------------------------------------------------------------- |
| **A (Выбрана)** | **Rate Limit + Autoscaling + Client Backoff** |                       5 |                              5 |                  3 |                        2 |                    2 |      **10** |    **7** |  **+3** | Комплексная защита на всех уровнях: отсекает атаки, справляется с нагрузкой, предотвращает retry-штормы. |
| **B**           | Только Autoscaling                            |                       1 |                              2 |                  2 |                        1 |                    1 |       **3** |    **4** |  **-1** | Совершенно неэффективно против DDoS. Приводит к перерасходу средств и последующему отказу.               |
| **C**           | Только Rate Limiting (без кооперации)         |                       3 |                              4 |                  2 |                        1 |                    1 |       **7** |    **4** |  **+3** | Защищает от атак, но может блокировать легитимных пользователей и провоцировать retry-штормы.            |
| **D**           | Внешний Anti-DDoS провайдер (Cloudflare)      |                       5 |                              5 |                  4 |                        3 |                    4 |      **10** |   **11** |  **-1** | Максимальная защита, но высокая стоимость, сложность интеграции и зависимость от внешнего провайдера.    |

---

## 3) Тай-брейкеры при равенстве Net

Варианты `A` и `C` имеют одинаковый `Net Score = +3`. Применяем тай-брейкеры:

- **Maintainability:** Вариант `A` за счет кооперации с клиентом (`Retry-After`) создает более предсказуемую и управляемую систему. Вариант `C` постоянно требует тонкой настройки лимитов, чтобы найти баланс между блокировкой атак и пропуском легитимного трафика.
- **Team fit:** Команда уже имеет экспертизу в настройке HPA и API Gateway. Добавление логики `Retry-After` и Backoff является стандартной практикой, не требующей уникальных навыков.

**Вывод:** Вариант `A` предпочтительнее, так как он создает более устойчивую и саморегулирующуюся систему.

## 4) Решение (для переноса в ADR)

- **Chosen alternative:** `A` - **Rate Limit + Autoscaling + Client Backoff**
- **Почему:** Этот вариант обеспечивает наилучший баланс между эффективностью защиты, стоимостью и сложностью внедрения. Он создает многоуровневую защиту (defense-in-depth), которая эффективна как против злонамеренных атак, так и против легитимных всплесков нагрузки, при этом избегая "retry-штормов" за счет кооперации с клиентом. Внешний провайдер (D) является избыточным на текущем этапе.
- **ADR candidate (название):** `Rate Limiting and Autoscaling Strategy`
- **Связки:** Risk-ID `R-02`, NFR-ID `NFR-001`, `NFR-002`, DFD `Edge: UA -> Wishlist_GW`.
- **Следующие шаги:**
  1. Настроить Rate Limiting и `Retry-After` на API Gateway.
  2. Настроить Horizontal Pod Autoscaler (HPA) для `Wishlist_Service`.
  3. Реализовать логику Exponential Backoff в клиентских приложениях.
  4. Обновить API-документацию с описанием правил Rate Limiting.
  5. Создать дашборды в Grafana для мониторинга 429-х ответов и количества реплик.

# ADR: PII Masking and Anonymization in Logs

**Status**: `Proposed`

## Context

**Risk**: `R-01` "Утечка PII в логи и их несанкционированное чтение" (L=4, I=4, **Score=16**) (Top-1). Риск заключается в случайном или преднамеренном логировании персональных данных (email, имена), что нарушает требования приватности и регуляторов (GDPR).
**DFD**: Поток `Edge: Wishlist_Service -> Logs_Service` и хранилища `Logs_Service`, `Logs_PostgreSQL`.
**NFR**: `NFR-007 (Privacy/PII)`, `NFR-008 (Auditability)`.
**Assumptions**:

- Мы используем структурированное логирование (например, JSON).
- Существует централизованная библиотека или конфигурация для логирования в `Wishlist_Service`.
- PII-поля в DTO/моделях могут быть идентифицированы (например, по имени или через аннотации).

## Decision

Мы внедряем автоматическое маскирование PII на уровне сервиса (`Wishlist_Service`) **до** отправки логов во внешнюю систему (`Logs_Service`). Это будет реализовано через middleware в нашей библиотеке логирования, который будет перехватывать и обрабатывать все сообщения.

- **Политика 1: Автоматическое маскирование по аннотациям.**

  - **Описание**: В коде DTO/моделей поля с PII будут помечаться специальной аннотацией (например, `@PiiField`). Логирующий middleware будет автоматически находить эти поля в объектах и не допускать их появления в логах.
  - **Стратегия**: email -> `undefined`.
  - **Слой**: `Wishlist_Service` (Application Layer).

- **Политика 2: Резервное маскирование по паттерну.**
  - **Описание**: В качестве второго эшелона защиты, если аннотация пропущена, middleware будет применять маскирование на основе регулярных выражений для известных форматов PII (email, номера телефонов).
  - **Стратегия**: phone -> `+7(***)***-**-12`.
  - **Слой**: `Wishlist_Service` (Application Layer).

## Alternatives

- **Маскирование на уровне коллектора логов (e.g., Logstash/Fluentd)** - **Отклонено.** Причина: PII уже покинули доверенный контур сервиса и передавались по сети в открытом виде. Коллектор также может не иметь достаточного контекста для качественного маскирования.
- **Полный запрет на логирование объектов, содержащих PII** - **Отклонено.** Причина: Это серьезно затруднит отладку и расследование инцидентов. Нам нужно знать, что операция произошла и была связана с пользователем, но не его конкретные PII.
- **Ручное маскирование каждым разработчиком** - **Отклонено.** Причина: Человеческий фактор, непоследовательность, высокая вероятность ошибок. Не масштабируется и не обеспечивает надежной защиты.

## Consequences

- **Положительные:**
  - Значительное снижение риска утечки PII через логи, выполнение `NFR-007`.
  - Повышение уровня соответствия GDPR и другим регуляторным требованиям.
  - Разработчикам не нужно думать о маскировании в каждом месте логирования.
- **Негативные/издержки:**
  - Небольшое увеличение потребления CPU в сервисах из-за дополнительной обработки логов.
  - Требуется начальная работа по аннотированию всех существующих DTO с PII.

## DoD / Acceptance

**Given** в сервисе есть объект `user` с полем `email: "sensitive.user@example.com"`.
**When** сервис логирует этот объект: `logger.info("User login failed", user_data=user)`.
**Then** в `Logs_PostgreSQL` запись лога не содержит поле `email`, только внутренний `id` пользователя.

**Checks:**

- `test`: Unit-тест для логирующего middleware, который проверяет корректность маскирования для разных типов PII.
- `log`: Ручная и автоматическая проверка логов в хранилище (`Logs_PostgreSQL`) на отсутствие не-маскированных PII.
- `scan/policy`: Статический анализатор кода (SAST) настроен на поиск прямого логирования известных PII-полей в обход middleware.
- `metric`: Отсутствие алертов от системы мониторинга утечек данных (DLP), сканирующей логи.

## Rollback / Fallback

Маскирование будет управляться через feature flag / переменную окружения (`LOG_PII_MASKING_ENABLED=true/false`). В случае критических проблем с производительностью или функциональностью флаг можно будет отключить, временно вернувшись к старому поведению.

## Trace

- **DFD**: `Edge: Wishlist_Service -> Logs_Service`
- **STRIDE**: Риск `I` для потока `Wishlist_Service -> Logs_Service` и хранилищ `Logs_Service`, `Logs_PostgreSQL`.
- **Risk scoring**: `R-01` (Top-1)
- **NFR**: `NFR-007`, `NFR-008`
- **Issues**: `#SEC-001` (Implement PII Masking Middleware), `#SEC-002` (Audit DTOs for PII annotations).

## Ownership & Dates

**Owner**: Security Team Lead
**Reviewers**: Backend Team Lead, DevOps Team Lead
**Date created**: 2025-10-12
**Last updated**: 2025-10-12
